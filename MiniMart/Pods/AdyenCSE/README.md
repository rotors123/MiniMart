# Adyen CSE for iOS
[![Build Status](https://travis-ci.org/Adyen/adyen-cse-ios.svg?branch=master)](https://travis-ci.org/Adyen/AdyenCSE-iOS)
[![License](https://img.shields.io/cocoapods/l/AdyenCSE.svg?style=flat)](http://cocoapods.org/pods/AdyenDL)
[![CocoaPods](https://img.shields.io/cocoapods/p/AdyenCSE.svg?style=flat)](https://github.com/Adyen/AdyenCSE-iOS)
[![CocoaPods](https://img.shields.io/cocoapods/v/AdyenCSE.svg?style=flat)](http://cocoapods.org/?q=name%3AAdyenCSE)
[![Carthage compatible](https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat)](https://github.com/Carthage/Carthage)

This repository contains Adyen's Client-Side Encryption (CSE) library for iOS. With CSE card data is encrypted on a client side (in this case the iOS device) before you submit it through your own server to the Adyen API. By using CSE you reduce your scope of [PCI compliance](https://en.wikipedia.org/wiki/Payment_Card_Industry_Data_Security_Standard), because no raw card data travels through your server. This repository can be leveraged as a starting point to integrate Adyen's payment functionality fully in-app.

## Requirements
The AdyenCSE-iOS library is written in Objective-C and is compatible with apps supporting iOS 7.0 and up. Looking for the Android or web equivalent? We have the CSE library also available in Java ([AdyenCSE-Android](https://github.com/Adyen/AdyenCSE-Android)) and JavaScript ([AdyenCSE-web](https://github.com/Adyen/CSE-JS)).

All our CSE libraries rely on you [setting up your own server](https://docs.adyen.com/developers/adyen-mobile-checkout#merchantserver) for communicating with the Adyen API. By using a server you ensure that API authentication credentials never get exposed. Please note that you need to have [signed up for an account at Adyen](https://www.adyen.com/signup) before you can send requests to the Adyen API.

## Example

For your convenience this repository contains an example app that can be used as a reference while integrating. 

To run the example project, type in the terminal:

```ruby
pod try AdyenCSE
```

## Installation

AdyenCSE is available through either [CocoaPods](http://cocoapods.org) or [Carthage](https://github.com/Carthage/Carthage).

### Cocoapods

1. Add `pod 'AdyenCSE'` to your `Podfile`.
2. Run `pod install`.

### Carthage

1. Add `github 'adyen/adyen-cse-ios'` to your `Cartfile`.
2. Run `carthage update`.
3. Link the framework with your target as described in [Carthage Readme](https://github.com/Carthage/Carthage#adding-frameworks-to-an-application).

## Usage

The code below illustrates how you can collect and encrypt card payment data.

```obj-c
#import "AdyenCSE/AdyenCSE.h"

// Set the public key.
NSString *publicKey = @"10001|B243E873CB9220BAFE71...";

// Create a card object.
ADYCard *card = [ADYCard new];
card.generationtime = [NSDate new];
card.number = @"55551...";
card.holderName = @"John A...";
card.cvc = @"737";
card.expiryMonth = @"08";
card.expiryYear = @"2018";

// Encrypt card data.
NSData *cardData = [card encode];
NSString *encryptedCard = [ADYEncrypter encrypt:cardData publicKeyInHex:publicKey];
```

Note that you'll have to URL encode the `encryptedCard` value before sending it from the app to your server, as the `encryptedCard` is generated by the CSE library and must be exactly the same as you send it from the server to the Adyen API.

```obj-c
NSURL *url = [NSURL URLWithString:merchantPaymentAuthoriseUrl];
NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
request.HTTPMethod = @"POST";

NSString *body = [NSString stringWithFormat:@"encryptedCard=%@",[encryptedCardDetails urlEncodeUsingEncoding:NSUTF8StringEncoding]];
request.HTTPBody = [body dataUsingEncoding:NSUTF8StringEncoding];
```

## Next steps

### Server side

Once you get encrypted payment information on your server, you should submit it through an API call to the corresponding [Adyen endpoint](https://docs.adyen.com/developers/easy-encryption#apiendpointsee). For example, the code example below demonstrates how to pass payment data in JSON format:

```json
curl -u "ws@Company.YourCompany":"YourWsPassword" \
    -H "Content-Type: application/json" \
    -X POST \
    --data \
    '{
        "additionalData": {
        "card.encrypted.json":"adyenjs_0_1_4p1$..."
    },

    "amount" : {
        "value" : 2000,
        "currency" : "EUR"
    },

    "reference" : ["YourPaymentReference"],
    "merchantAccount" : ["YourMerchantAccountName"]
}'\
https://pal-test.adyen.com/pal/servlet/Payment/v18/authorise
```


### Recurring payments

If your business model requires to bill your customers on a recurring basis, you may enable recurring payments using the Adyen platform. In this case Adyen securely stores payment details when you make the first `authorisation` call, so that you no longer need to provide this data in the future.

To do this, add the `recurring` field to the payment request you make from your server to the Adyen platform. For example, if you want to enable both [shopper-not-present](https://docs.adyen.com/developers/recurring-manual#recurringpayment) and [one-click](https://docs.adyen.com/developers/recurring-manual#oneclickcardpayment) recurring modes for a specific payment, add the following field to the API call above:

```json
"recurring" : {
   "contract" : "RECURRING,ONECLICK"
}
```

For more information on recurring payments, refer to the [Adyen documentation](https://docs.adyen.com/developers/recurring-manual).

### Notifications

After you have developed your app, set up your merchant server and successfully performed your first [test payment](https://docs.adyen.com/developers/test-cards-manual) it's time to complete your integration by registering for Adyen's notification service. After each payment initiation we push a notification to your server with the authorisation response, so you can be sure whether you can start delivering your goods or services.

To subscribe to and integrate with the notification service, please check our [notification manual](https://docs.adyen.com/developers/easy-encryption#notificationsee).

### Going live

Successfully integrated with our notification service? Congratulations, now it's time to start accepting payments for real! Assuming that you've been using your Adyen test account and the Adyen API's test endpoints, you can now make use of your Adyen live account and Adyen API [live endpoints](https://docs.adyen.com/developers/easy-encryption#apiendpointsee).

## Questions?

If you have any questions or suggestions, please contact your account manager or send your inquiry to support@adyen.com.

## License

This repository is open-source and available under the [MIT license](https://en.wikipedia.org/wiki/MIT_License). See the LICENSE file for more information.

